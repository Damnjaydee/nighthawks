<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Inner Circle — RSVP</title>
  <meta name="color-scheme" content="dark"/>
  <link href="https://fonts.googleapis.com/css2?family=Bodoni+Moda:opsz,wght@7..96,600&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    :root{ --ink:#eae7df; --paper:#0b0b0b; --line:rgba(234,231,223,.18); --gold:#bda874; --error:#ffbcbc }
    *{box-sizing:border-box} html,body{height:100%}
    body{ margin:0; background:var(--paper); color:var(--ink); font-family:'Inter',system-ui,Arial,sans-serif; }
    .wrap{min-height:100%; display:grid; place-items:center; padding:6vh 16px 10vh}
    .card{ width:min(720px,92vw); background:rgba(255,255,255,.03);
           border:1px solid var(--line); border-radius:20px; padding:36px 40px;
           backdrop-filter: blur(8px) saturate(120%); box-shadow:0 18px 60px rgba(0,0,0,.45); }
    .mast{ display:flex; align-items:flex-end; justify-content:space-between; margin-bottom:18px; }
    .wordmark{ font-family:'Bodoni Moda',serif; font-size:28px; letter-spacing:.08em; }
    .smallcaps{ text-transform:uppercase; font-size:.75rem; letter-spacing:.24em; opacity:.75 }
    h1{font-family:'Bodoni Moda',serif; font-size:1.35rem; margin:8px 0 2px}
    .lede{opacity:.85; margin:0 0 12px}
    .summary{margin:10px 0 18px; font-size:.95rem; opacity:.9}
    .code-view{font-family:ui-monospace,Menlo,Consolas,monospace; color:var(--gold); letter-spacing:.12em}

    form{display:grid; gap:14px}
    label{font-size:.78rem; letter-spacing:.18em; text-transform:uppercase; opacity:.75}
    input, select, textarea{
      width:100%; background:transparent; color:var(--ink); font-size:1rem;
      border:none; border-bottom:1px solid var(--line); padding:12px 2px 10px 2px; outline:none;
    }
    textarea{min-height:84px; resize:vertical}
    input:focus, select:focus, textarea:focus{ border-bottom-color:var(--gold) }

    .row{display:grid; grid-template-columns:1fr 1fr; gap:14px}
    @media (max-width:720px){ .row{grid-template-columns:1fr} }

    .radios{display:flex; gap:14px; flex-wrap:wrap}
    .radio{display:flex; align-items:center; gap:8px; padding:8px 10px; border:1px solid var(--line); border-radius:12px}
    .radio input{border:0; padding:0; width:auto}

    .btn{ margin-top:8px; padding:12px 16px; border-radius:12px;
          border:1px solid var(--ink); background:transparent; color:var(--ink);
          text-transform:uppercase; letter-spacing:.12em; font-weight:600; cursor:pointer; transition:opacity .15s ease }
    .btn:hover{ background:var(--ink); color:#111 }
    .btn[disabled]{opacity:.6; cursor:not-allowed}

    .err{color:var(--error); min-height:1.2em; margin-top:6px}
    .hint{opacity:.7; font-size:.9rem}
    .hr{height:1px; background:linear-gradient(90deg,transparent,rgba(255,255,255,.12),transparent); margin:14px 0}
  </style>
</head>
<body>
  <main class="wrap">
    <section class="card" role="main">
      <div class="mast">
        <div class="wordmark">Inner Circle</div>
        <div class="smallcaps">Private RSVP</div>
      </div>

      <h1>Kindly confirm your attendance</h1>
      <p class="lede">Details are shared privately upon confirmation.</p>

      <div class="summary">
        <span id="summaryName">Guest</span> — Access code <span id="summaryCode" class="code-view">—</span>
      </div>

      <form id="rsvpForm" novalidate>
        <div class="row">
          <div>
            <label for="firstName">First name</label>
            <input id="firstName" name="firstName" autocomplete="given-name" required />
          </div>
          <div>
            <label for="lastName">Last name</label>
            <input id="lastName" name="lastName" autocomplete="family-name" required />
          </div>
        </div>

        <div>
          <label>How should we notify you?</label>
          <div class="radios" role="radiogroup" aria-label="Notify">
            <label class="radio"><input type="radio" name="notify" value="email"> Email</label>
            <label class="radio"><input type="radio" name="notify" value="text"> Text</label>
            <label class="radio"><input type="radio" name="notify" value="both"> Both</label>
          </div>
        </div>

        <div class="row">
          <div>
            <label for="email">Email</label>
            <input id="email" name="email" type="email" inputmode="email" autocomplete="email" />
          </div>
          <div>
            <label for="phone">Phone</label>
            <input id="phone" name="phone" type="tel" inputmode="tel" autocomplete="tel" />
          </div>
        </div>

        <div>
          <label>Plus one</label>
          <div class="radios" role="radiogroup" aria-label="Plus one">
            <label class="radio"><input type="radio" name="plusOne" value="no" checked> No</label>
            <label class="radio"><input type="radio" name="plusOne" value="yes"> Yes</label>
          </div>
        </div>

        <div id="plusOneWrap" style="display:none">
          <label for="guestName">Guest name</label>
          <input id="guestName" name="guestName" placeholder="Full name" />
        </div>

        <div class="hr"></div>

        <div>
          <label for="diet">Dietary notes</label>
          <textarea id="diet" name="diet" placeholder="Allergies or preferences (optional)"></textarea>
        </div>

        <div>
          <label for="notes">Notes</label>
          <textarea id="notes" name="notes" placeholder="Anything else we should know? (optional)"></textarea>
        </div>

        <input type="hidden" id="code" name="code"/>
        <button class="btn" id="submitBtn" type="submit">Confirm RSVP</button>
        <div id="err" class="err" role="alert" aria-live="polite"></div>
        <p class="hint">This invitation is strictly personal and non-transferable.</p>
      </form>
    </section>
  </main>

  <script>
    // read query for name/code
    const qs = new URLSearchParams(location.search);
    const code = (qs.get('code') || '').replace(/[–—−]/g,'-').replace(/\s+/g,'').toUpperCase();
    const prefillName = (qs.get('name') || '').trim();

    document.getElementById('summaryCode').textContent = code || '—';
    if (prefillName) document.getElementById('summaryName').textContent = prefillName;
    document.getElementById('code').value = code;

    // plus-one toggle
    const plusRadios = Array.from(document.querySelectorAll('input[name="plusOne"]'));
    const plusWrap = document.getElementById('plusOneWrap');
    plusRadios.forEach(r => r.addEventListener('change', () => {
      plusWrap.style.display = (document.querySelector('input[name="plusOne"]:checked').value === 'yes') ? 'block' : 'none';
    }));

    const form = document.getElementById('rsvpForm');
    const btn  = document.getElementById('submitBtn');
    const err  = document.getElementById('err');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      err.textContent = '';
      btn.disabled = true;

      const data = Object.fromEntries(new FormData(form).entries());
      // front-end validation
      if (!data.firstName || !data.lastName) {
        err.textContent = 'Please add your first and last name.'; btn.disabled = false; return;
      }
      if (!data.notify) {
        err.textContent = 'Please choose how we should notify you.'; btn.disabled = false; return;
      }
      if ((data.notify === 'email' || data.notify === 'both') && !data.email) {
        err.textContent = 'Please provide an email.'; btn.disabled = false; return;
      }
      if ((data.notify === 'text'  || data.notify === 'both') && !data.phone) {
        err.textContent = 'Please provide a phone number.'; btn.disabled = false; return;
      }
      if (!data.code) {
        err.textContent = 'Missing access code. Please return to your invite link.'; btn.disabled = false; return;
      }

      try {
        const res = await fetch('/api/rsvp', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            code: data.code,
            firstName: data.firstName,
            lastName: data.lastName,
            plusOne: data.plusOne,            // "yes" | "no"
            guestName: data.guestName || '',
            notify: data.notify,              // "email" | "text" | "both"
            email: data.email || '',
            phone: data.phone || '',
            diet: data.diet || '',
            notes: data.notes || ''
          })
        });
        const ok = res.ok && (await res.json()).ok;
        if (!ok) throw new Error('RSVP failed');

        // success → send to your existing confirm page with context
        const u = new URL('/rsvp-confirm.html', location.origin);
        const fullName = `${data.firstName} ${data.lastName}`.trim();
        if (fullName) u.searchParams.set('name', fullName);
        u.searchParams.set('code', data.code);
        // choose a primary contact string for display
        const contact = data.notify === 'email' ? data.email
                      : data.notify === 'text'  ? data.phone
                      : `${data.email || ''} ${data.phone ? ' / ' + data.phone : ''}`.trim();
        if (contact) u.searchParams.set('ct', contact);
        if (data.plusOne === 'yes' && data.guestName) u.searchParams.set('plus', data.guestName);
        const noteBlob = [data.diet, data.notes].filter(Boolean).join(' — ');
        if (noteBlob) u.searchParams.set('notes', noteBlob);
        location.href = u.toString();

      } catch (e) {
        err.textContent = 'We couldn’t save your RSVP. Please try again in a moment.';
        btn.disabled = false;
      }
    });
  </script>
</body>
</html>
